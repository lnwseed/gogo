#!/data/data/com.termux/files/usr/bin/bash

#============================================
# Universal Frida Auto-Installer
# ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á Frida + frida-server ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
# ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏∏‡∏Å Android version, ‡∏ó‡∏∏‡∏Å architecture
# Version: 2.0
#============================================

set -e

# ‡∏™‡∏µ
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
WHITE='\033[1;37m'
NC='\033[0m'

# ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç
LOG_FILE="$HOME/frida_install_$(date +%Y%m%d_%H%M%S).log"
FRIDA_VERSION=""
PYTHON_VERSION=""
ANDROID_VERSION=""
ARCHITECTURE=""
TERMUX_VERSION=""

# ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
print_header() {
    clear
    echo ""
    echo -e "${BLUE}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
    echo -e "${BLUE}‚ïë  üöÄ Universal Frida Auto-Installer üöÄ  ‚ïë${NC}"
    echo -e "${BLUE}‚ïë        All-in-One Installation          ‚ïë${NC}"
    echo -e "${BLUE}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
    echo ""
}

print_section() {
    echo ""
    echo -e "${CYAN}‚ñ∂ $1${NC}"
    echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
}

print_success() {
    echo -e "${GREEN}‚úì${NC} $1"
}

print_error() {
    echo -e "${RED}‚úó${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}‚ö†${NC} $1"
}

print_info() {
    echo -e "${BLUE}‚Ñπ${NC} $1"
}

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> "$LOG_FILE"
}

#============================================
# ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏†‡∏≤‡∏û‡πÅ‡∏ß‡∏î‡∏•‡πâ‡∏≠‡∏°
#============================================

check_environment() {
    print_section "‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏†‡∏≤‡∏û‡πÅ‡∏ß‡∏î‡∏•‡πâ‡∏≠‡∏°"
    
    # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô Termux ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    if [ ! -d "/data/data/com.termux" ]; then
        print_error "‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ô‡πÉ‡∏ô Termux!"
        exit 1
    fi
    print_success "‡∏£‡∏±‡∏ô‡πÉ‡∏ô Termux"
    log "Running in Termux"
    
    # Architecture
    ARCHITECTURE=$(uname -m)
    case $ARCHITECTURE in
        aarch64)
            FRIDA_ARCH="arm64"
            ;;
        armv7l|armv8l)
            FRIDA_ARCH="arm"
            ;;
        x86_64)
            FRIDA_ARCH="x86_64"
            ;;
        i686|x86)
            FRIDA_ARCH="x86"
            ;;
        *)
            print_error "Unknown architecture: $ARCHITECTURE"
            exit 1
            ;;
    esac
    print_success "Architecture: $ARCHITECTURE ($FRIDA_ARCH)"
    log "Architecture: $ARCHITECTURE ($FRIDA_ARCH)"
    
    # Android Version
    ANDROID_VERSION=$(getprop ro.build.version.release 2>/dev/null || echo "Unknown")
    ANDROID_SDK=$(getprop ro.build.version.sdk 2>/dev/null || echo "0")
    print_success "Android: $ANDROID_VERSION (SDK $ANDROID_SDK)"
    log "Android: $ANDROID_VERSION (SDK $ANDROID_SDK)"
    
    # Security Patch Level
    SECURITY_PATCH=$(getprop ro.build.version.security_patch 2>/dev/null || echo "Unknown")
    print_info "Security Patch: $SECURITY_PATCH"
    log "Security Patch: $SECURITY_PATCH"
    
    # Python Version
    if command -v python &> /dev/null; then
        PYTHON_VERSION=$(python --version 2>&1 | awk '{print $2}')
        print_success "Python: $PYTHON_VERSION"
        log "Python: $PYTHON_VERSION"
    else
        print_warning "Python not found (will install)"
        log "Python not found"
    fi
    
    # Termux Version
    TERMUX_VERSION=$(pkg list-installed 2>/dev/null | grep "^termux/" | head -1 | awk '{print $2}' || echo "Unknown")
    print_info "Termux: $TERMUX_VERSION"
    log "Termux: $TERMUX_VERSION"
    
    # Storage Permission
    if [ -d "$HOME/storage" ]; then
        print_success "Storage access configured"
    else
        print_warning "Storage access not configured"
        print_info "Run: termux-setup-storage"
    fi
    
    # Root Check
    echo ""
    print_info "Checking root access..."
    if su -c "echo test" &>/dev/null; then
        print_success "Root access available"
        log "Root access: Yes"
    else
        print_error "No root access!"
        print_warning "This script requires root for frida-server"
        echo ""
        read -p "Continue anyway? (y/n): " continue_choice
        if [[ ! "$continue_choice" =~ ^[Yy]$ ]]; then
            exit 1
        fi
        log "Root access: No (continued anyway)"
    fi
}

#============================================
# ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á Dependencies
#============================================

install_dependencies() {
    print_section "‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á Dependencies"
    
    # Update package list
    print_info "Updating package lists..."
    pkg update -y 2>&1 | tee -a "$LOG_FILE" | grep -v "^Reading" || true
    print_success "Package lists updated"
    
    # Essential packages
    local packages=(
        "python"
        "wget"
        "curl"
        "git"
        "build-essential"
        "binutils"
        "pkg-config"
        "xz-utils"
    )
    
    print_info "Installing essential packages..."
    for pkg_name in "${packages[@]}"; do
        if ! dpkg -l | grep -q "^ii.*$pkg_name"; then
            echo -n "  Installing $pkg_name... "
            if pkg install "$pkg_name" -y >> "$LOG_FILE" 2>&1; then
                echo -e "${GREEN}‚úì${NC}"
                log "Installed: $pkg_name"
            else
                echo -e "${YELLOW}‚ö†${NC}"
                log "Failed to install: $pkg_name"
            fi
        else
            echo -e "  $pkg_name: ${GREEN}already installed${NC}"
        fi
    done
    
    # Root repo (for tsu)
    print_info "Setting up root repository..."
    if ! dpkg -l | grep -q "^ii.*root-repo"; then
        if pkg install root-repo -y >> "$LOG_FILE" 2>&1; then
            print_success "root-repo installed"
            log "Installed: root-repo"
            pkg update -y >> "$LOG_FILE" 2>&1
        else
            print_warning "Failed to install root-repo"
            log "Failed: root-repo"
        fi
    else
        print_success "root-repo already installed"
    fi
    
    # tsu (su wrapper)
    if ! command -v tsu &> /dev/null; then
        print_info "Installing tsu..."
        if pkg install tsu -y >> "$LOG_FILE" 2>&1; then
            print_success "tsu installed"
            log "Installed: tsu"
        else
            print_warning "Failed to install tsu (not critical)"
            log "Failed: tsu"
        fi
    else
        print_success "tsu already installed"
    fi
    
    # Python packages
    print_info "Installing Python build dependencies..."
    if pip list 2>/dev/null | grep -q wheel; then
        print_success "Python build tools ready"
    else
        pip install --upgrade pip wheel setuptools --break-system-packages >> "$LOG_FILE" 2>&1 || true
        print_success "Python build tools installed"
    fi
}

#============================================
# ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ‡∏Ç‡∏≠‡∏á Frida
#============================================

detect_compatible_frida_version() {
    print_section "‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Frida Version ‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö"
    
    # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Python version
    local python_major=$(python --version 2>&1 | awk '{print $2}' | cut -d. -f1)
    local python_minor=$(python --version 2>&1 | awk '{print $2}' | cut -d. -f2)
    
    print_info "Python version: $python_major.$python_minor"
    
    # ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Frida version ‡∏ï‡∏≤‡∏° Android SDK ‡πÅ‡∏•‡∏∞ Python
    local recommended_version=""
    
    # ‡∏ï‡∏≤‡∏° Android version
    if [ "$ANDROID_SDK" -ge 34 ]; then
        # Android 14+
        recommended_version="17.6.1"
        print_info "Android 14+ detected ‚Üí Trying Frida 17.6.1"
    elif [ "$ANDROID_SDK" -ge 33 ]; then
        # Android 13
        recommended_version="17.2.14"
        print_info "Android 13 detected ‚Üí Trying Frida 17.2.14"
    elif [ "$ANDROID_SDK" -ge 31 ]; then
        # Android 12
        recommended_version="16.5.9"
        print_info "Android 12 detected ‚Üí Trying Frida 16.5.9"
    elif [ "$ANDROID_SDK" -ge 29 ]; then
        # Android 10-11
        recommended_version="16.0.19"
        print_info "Android 10-11 detected ‚Üí Trying Frida 16.0.19"
    else
        # Android 9 ‡∏•‡∏á‡πÑ‡∏õ
        recommended_version="15.2.2"
        print_info "Android 9- detected ‚Üí Trying Frida 15.2.2"
    fi
    
    # ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏î‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    print_info "Testing Frida $recommended_version compatibility..."
    
    # ‡∏•‡∏≠‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á (‡πÅ‡∏ö‡∏ö dry-run)
    if pip install --dry-run frida-tools==$recommended_version --break-system-packages >> "$LOG_FILE" 2>&1; then
        FRIDA_VERSION="$recommended_version"
        print_success "Frida $FRIDA_VERSION is compatible"
        log "Compatible Frida version: $FRIDA_VERSION"
    else
        # ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡∏•‡∏≠‡∏á‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤
        print_warning "Frida $recommended_version not compatible"
        
        local fallback_versions=(
            "17.2.14"
            "16.5.9"
            "16.0.19"
            "15.2.2"
            "15.1.17"
        )
        
        for version in "${fallback_versions[@]}"; do
            print_info "Trying Frida $version..."
            if pip install --dry-run frida-tools==$version --break-system-packages >> "$LOG_FILE" 2>&1; then
                FRIDA_VERSION="$version"
                print_success "Frida $FRIDA_VERSION is compatible"
                log "Compatible Frida version (fallback): $FRIDA_VERSION"
                break
            fi
        done
        
        if [ -z "$FRIDA_VERSION" ]; then
            print_error "No compatible Frida version found!"
            print_info "Defaulting to latest available..."
            FRIDA_VERSION="latest"
        fi
    fi
    
    echo ""
    print_success "Selected Frida version: $FRIDA_VERSION"
}

#============================================
# ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á Frida Tools
#============================================

install_frida_tools() {
    print_section "‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á Frida Tools"
    
    # ‡∏ñ‡∏≠‡∏ô‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
    if pip list 2>/dev/null | grep -q "^frida "; then
        print_info "Removing old Frida installation..."
        pip uninstall frida frida-tools -y >> "$LOG_FILE" 2>&1 || true
        print_success "Old version removed"
    fi
    
    # ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà
    print_info "Installing Frida Tools $FRIDA_VERSION..."
    echo "This may take a few minutes..."
    
    if [ "$FRIDA_VERSION" = "latest" ]; then
        if pip install frida-tools --break-system-packages 2>&1 | tee -a "$LOG_FILE" | grep -E "(Successfully|Requirement)"; then
            print_success "Frida Tools installed"
            FRIDA_VERSION=$(frida --version 2>/dev/null)
            log "Installed Frida Tools: $FRIDA_VERSION"
        else
            print_error "Failed to install Frida Tools"
            return 1
        fi
    else
        if pip install frida-tools==$FRIDA_VERSION --break-system-packages 2>&1 | tee -a "$LOG_FILE" | grep -E "(Successfully|Requirement)"; then
            print_success "Frida Tools $FRIDA_VERSION installed"
            log "Installed Frida Tools: $FRIDA_VERSION"
        else
            print_error "Failed to install Frida Tools $FRIDA_VERSION"
            return 1
        fi
    fi
    
    # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á
    if command -v frida &> /dev/null; then
        local installed_version=$(frida --version 2>/dev/null)
        print_success "Frida CLI: $installed_version"
        FRIDA_VERSION="$installed_version"
    else
        print_error "Frida installation failed"
        return 1
    fi
}

#============================================
# ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á Frida Server
#============================================

install_frida_server() {
    print_section "‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á Frida Server"
    
    print_info "Version: $FRIDA_VERSION"
    print_info "Architecture: $FRIDA_ARCH"
    
    # ‡∏™‡∏£‡πâ‡∏≤‡∏á URL ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î
    local download_url="https://github.com/frida/frida/releases/download/$FRIDA_VERSION/frida-server-$FRIDA_VERSION-android-$FRIDA_ARCH.xz"
    
    print_info "Download URL: $download_url"
    log "Download URL: $download_url"
    
    # ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
    local temp_dir="$HOME/.frida_temp"
    mkdir -p "$temp_dir"
    cd "$temp_dir"
    
    # ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î
    print_info "Downloading frida-server..."
    if wget "$download_url" -O frida-server.xz 2>&1 | grep -E "(saved|100%)"; then
        print_success "Downloaded successfully"
        log "Downloaded frida-server"
    else
        print_error "Download failed"
        print_info "Trying with curl..."
        if curl -L "$download_url" -o frida-server.xz 2>&1 | grep -E "(100|Downloaded)"; then
            print_success "Downloaded successfully (curl)"
            log "Downloaded frida-server (curl)"
        else
            print_error "Download failed with both wget and curl"
            log "Download failed"
            return 1
        fi
    fi
    
    # ‡πÅ‡∏ï‡∏Å‡πÑ‡∏ü‡∏•‡πå
    print_info "Extracting..."
    if xz -d frida-server.xz 2>&1 | tee -a "$LOG_FILE"; then
        print_success "Extracted"
    else
        print_error "Extraction failed"
        return 1
    fi
    
    # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏ü‡∏•‡πå
    if [ ! -f "frida-server" ]; then
        print_error "frida-server file not found after extraction"
        return 1
    fi
    
    # ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á
    print_info "Installing frida-server..."
    
    # ‡∏´‡∏¢‡∏∏‡∏î frida-server ‡πÄ‡∏î‡∏¥‡∏°
    su -c "killall frida-server 2>/dev/null" || true
    sleep 1
    
    # ‡∏™‡∏≥‡∏£‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°
    su -c "[ -f /data/local/tmp/frida-server ] && mv /data/local/tmp/frida-server /data/local/tmp/frida-server.backup" || true
    
    # ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà
    if su -c "cp $temp_dir/frida-server /data/local/tmp/frida-server && chmod 755 /data/local/tmp/frida-server"; then
        print_success "frida-server installed to /data/local/tmp/"
        log "Installed frida-server"
    else
        print_error "Failed to install frida-server"
        return 1
    fi
    
    # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô
    local server_version=$(su -c "/data/local/tmp/frida-server --version" 2>/dev/null)
    print_success "frida-server version: $server_version"
    log "frida-server version: $server_version"
    
    # ‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î
    cd "$HOME"
    rm -rf "$temp_dir"
    
    # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô
    if [ "$FRIDA_VERSION" != "$server_version" ]; then
        print_warning "Version mismatch!"
        print_warning "  Client: $FRIDA_VERSION"
        print_warning "  Server: $server_version"
        print_info "This might cause issues"
    else
        print_success "Version match: $FRIDA_VERSION"
    fi
}

#============================================
# ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ SELinux
#============================================

configure_selinux() {
    print_section "‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ SELinux"
    
    local selinux_status=$(su -c "getenforce" 2>/dev/null || echo "Unknown")
    print_info "Current SELinux: $selinux_status"
    
    if [ "$selinux_status" = "Enforcing" ]; then
        print_warning "SELinux is Enforcing (may cause issues)"
        echo ""
        read -p "Set SELinux to Permissive? (Recommended) (y/n): " selinux_choice
        
        if [[ "$selinux_choice" =~ ^[Yy]$ ]]; then
            if su -c "setenforce 0" 2>/dev/null; then
                print_success "SELinux set to Permissive"
                log "SELinux: Permissive"
                print_warning "Note: This is temporary (resets after reboot)"
            else
                print_warning "Failed to set SELinux (not critical)"
            fi
        fi
    elif [ "$selinux_status" = "Permissive" ]; then
        print_success "SELinux is already Permissive"
    fi
}

#============================================
# ‡πÄ‡∏£‡∏¥‡πà‡∏° Frida Server
#============================================

start_frida_server() {
    print_section "‡πÄ‡∏£‡∏¥‡πà‡∏° Frida Server"
    
    # ‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏î‡∏¥‡∏°
    su -c "killall frida-server 2>/dev/null" || true
    sleep 1
    
    # ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà
    print_info "Starting frida-server..."
    if su -c "/data/local/tmp/frida-server &" 2>&1 | tee -a "$LOG_FILE"; then
        sleep 2
        
        # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏£‡∏±‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        if su -c "pgrep -f frida-server" > /dev/null; then
            local pid=$(su -c "pgrep -f frida-server")
            print_success "frida-server started (PID: $pid)"
            log "frida-server started: PID $pid"
        else
            print_error "frida-server failed to start"
            log "frida-server failed to start"
            return 1
        fi
    else
        print_error "Failed to start frida-server"
        return 1
    fi
    
    # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏û‡∏≠‡∏£‡πå‡∏ï
    sleep 1
    if su -c "netstat -tulpn 2>/dev/null | grep 27042" > /dev/null || \
       su -c "ss -tulpn 2>/dev/null | grep 27042" > /dev/null; then
        print_success "Port 27042 is listening"
    else
        print_warning "Port 27042 not detected (might be normal)"
    fi
}

#============================================
# ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Frida
#============================================

test_frida() {
    print_section "‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô"
    
    print_info "Connection mode: -H 127.0.0.1:27042"
    print_info "Testing Frida connection..."
    sleep 2
    
    # ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏ö‡∏ö -H (localhost)
    if frida-ps -H 127.0.0.1:27042 &> /dev/null; then
        print_success "Frida is working! (localhost mode)"
        echo ""
        print_info "Sample processes (top 10):"
        frida-ps -H 127.0.0.1:27042 | head -11
        log "Frida test: Success (localhost)"
        
        # ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ
        echo ""
        print_info "Connection command:"
        echo "  frida-ps -H 127.0.0.1:27042"
        
        return 0
    else
        print_error "Cannot connect to frida-server"
        log "Frida test: Failed"
        
        print_info "Troubleshooting..."
        
        # ‡πÄ‡∏ä‡πá‡∏Ñ process
        if su -c "pgrep -f frida-server" > /dev/null; then
            print_info "frida-server is running"
        else
            print_warning "frida-server is not running"
            print_info "Try: ~/frida-start"
        fi
        
        # ‡πÄ‡∏ä‡πá‡∏Ñ‡∏û‡∏≠‡∏£‡πå‡∏ï
        if su -c "netstat -tulpn 2>/dev/null | grep 27042" > /dev/null; then
            print_info "Port 27042 is listening"
        else
            print_warning "Port 27042 not listening"
        fi
        
        # ‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô
        local client_ver=$(frida --version 2>/dev/null || echo "unknown")
        local server_ver=$(su -c "/data/local/tmp/frida-server --version" 2>/dev/null || echo "unknown")
        
        print_info "Client version: $client_ver"
        print_info "Server version: $server_ver"
        
        if [ "$client_ver" != "$server_ver" ]; then
            print_warning "Version mismatch detected!"
        fi
        
        # ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
        echo ""
        print_info "Quick fixes:"
        echo "  1. ~/frida-start"
        echo "  2. su -c 'setenforce 0'"
        echo "  3. frida-ps -H 127.0.0.1:27042"
        
        return 1
    fi
}

#============================================
# ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠
#============================================

create_helper_scripts() {
    print_section "‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠"
    
    # frida-start
    cat > "$HOME/frida-start" << 'EOFSTART'
#!/data/data/com.termux/files/usr/bin/bash
echo "üöÄ Starting Frida Server..."
su -c "killall frida-server 2>/dev/null"
sleep 1
su -c "/data/local/tmp/frida-server &"
sleep 2
if pgrep -f frida-server > /dev/null; then
    echo "‚úì Frida Server started (PID: $(pgrep -f frida-server))"
    echo ""
    echo "Testing connection..."
    if frida-ps -H 127.0.0.1:27042 &>/dev/null; then
        echo "‚úì Connection successful!"
        echo ""
        echo "Sample processes:"
        frida-ps -H 127.0.0.1:27042 | head -5
    else
        echo "‚úó Connection failed"
        echo ""
        echo "Try:"
        echo "  su -c 'setenforce 0'"
        echo "  frida-ps -H 127.0.0.1:27042"
    fi
else
    echo "‚úó Failed to start"
fi
EOFSTART
    chmod +x "$HOME/frida-start"
    print_success "Created: ~/frida-start"
    
    # frida-stop
    cat > "$HOME/frida-stop" << 'EOFSTOP'
#!/data/data/com.termux/files/usr/bin/bash
echo "üõë Stopping Frida Server..."
su -c "killall frida-server 2>/dev/null"
sleep 1
if ! pgrep -f frida-server > /dev/null; then
    echo "‚úì Frida Server stopped"
else
    echo "‚ö† Failed to stop (trying force kill)"
    su -c "killall -9 frida-server 2>/dev/null"
    sleep 1
    if ! pgrep -f frida-server > /dev/null; then
        echo "‚úì Frida Server stopped (forced)"
    else
        echo "‚úó Still running (PID: $(pgrep -f frida-server))"
    fi
fi
EOFSTOP
    chmod +x "$HOME/frida-stop"
    print_success "Created: ~/frida-stop"
    
    # frida-status
    cat > "$HOME/frida-status" << 'EOFSTATUS'
#!/data/data/com.termux/files/usr/bin/bash
echo "üìä Frida Status"
echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
echo ""

# Versions
echo "üîπ Versions:"
CLIENT_VER=$(frida --version 2>/dev/null || echo 'Not installed')
SERVER_VER=$(su -c '/data/local/tmp/frida-server --version' 2>/dev/null || echo 'Not installed')
echo "  Client: $CLIENT_VER"
echo "  Server: $SERVER_VER"

if [ "$CLIENT_VER" != "$SERVER_VER" ] && [ "$CLIENT_VER" != "Not installed" ] && [ "$SERVER_VER" != "Not installed" ]; then
    echo "  ‚ö†Ô∏è  Version mismatch!"
fi
echo ""

# Process
echo "üîπ Process:"
if pgrep -f frida-server > /dev/null; then
    PID=$(pgrep -f frida-server)
    echo "  ‚úì Running (PID: $PID)"
else
    echo "  ‚úó Not running"
fi
echo ""

# Port
echo "üîπ Port 27042:"
if su -c "netstat -tulpn 2>/dev/null | grep 27042" > /dev/null || \
   su -c "ss -tulpn 2>/dev/null | grep 27042" > /dev/null; then
    echo "  ‚úì Listening"
else
    echo "  ‚úó Not listening"
fi
echo ""

# Connection
echo "üîπ Connection Test:"
echo "  Mode: -H 127.0.0.1:27042"
if frida-ps -H 127.0.0.1:27042 &>/dev/null; then
    PROC_COUNT=$(frida-ps -H 127.0.0.1:27042 2>/dev/null | wc -l)
    echo "  ‚úì Connected ($PROC_COUNT processes)"
else
    echo "  ‚úó Failed"
fi
echo ""

# SELinux
echo "üîπ SELinux:"
SELINUX=$(su -c "getenforce" 2>/dev/null || echo "Unknown")
echo "  Status: $SELINUX"
if [ "$SELINUX" = "Enforcing" ]; then
    echo "  ‚ö†Ô∏è  May cause connection issues"
    echo "  Fix: su -c 'setenforce 0'"
fi
echo ""

# Quick commands
echo "üîπ Quick Commands:"
echo "  Start:  ~/frida-start"
echo "  Stop:   ~/frida-stop"
echo "  Test:   frida-ps -H 127.0.0.1:27042"
echo "  Bypass: su -c 'setenforce 0'"
EOFSTATUS
    chmod +x "$HOME/frida-status"
    print_success "Created: ~/frida-status"
    
    # frida-test (‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠)
    cat > "$HOME/frida-test" << 'EOFTEST'
#!/data/data/com.termux/files/usr/bin/bash
echo "üß™ Testing Frida Connection"
echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
echo ""

# Connection modes
echo "Testing connection modes..."
echo ""

# Mode 1: -H 127.0.0.1:27042 (Recommended)
echo "1Ô∏è‚É£ Mode: -H 127.0.0.1:27042"
if frida-ps -H 127.0.0.1:27042 &>/dev/null; then
    echo "   ‚úì Success"
    WORKING_MODE="localhost"
else
    echo "   ‚úó Failed"
fi
echo ""

# Mode 2: -U (USB/Auto-detect)
echo "2Ô∏è‚É£ Mode: -U (auto-detect)"
if frida-ps -U &>/dev/null; then
    echo "   ‚úì Success"
    if [ -z "$WORKING_MODE" ]; then
        WORKING_MODE="usb"
    fi
else
    echo "   ‚úó Failed"
fi
echo ""

# Mode 3: -R (Remote)
echo "3Ô∏è‚É£ Mode: -R (remote)"
if frida-ps -R &>/dev/null; then
    echo "   ‚úì Success"
    if [ -z "$WORKING_MODE" ]; then
        WORKING_MODE="remote"
    fi
else
    echo "   ‚úó Failed"
fi
echo ""

# Summary
echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
if [ -n "$WORKING_MODE" ]; then
    echo "‚úÖ Frida is working! (mode: $WORKING_MODE)"
    echo ""
    echo "Recommended command:"
    echo "  frida-ps -H 127.0.0.1:27042"
    echo ""
    echo "Sample processes:"
    frida-ps -H 127.0.0.1:27042 2>/dev/null | head -5 || frida-ps -U 2>/dev/null | head -5
else
    echo "‚ùå Frida is not working"
    echo ""
    echo "Troubleshooting:"
    echo "  1. ~/frida-start"
    echo "  2. su -c 'setenforce 0'"
    echo "  3. ~/frida-status"
fi
EOFTEST
    chmod +x "$HOME/frida-test"
    print_success "Created: ~/frida-test"
    
    log "Helper scripts created"
}

#============================================
# ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•
#============================================

show_summary() {
    echo ""
    echo -e "${BLUE}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
    echo -e "${BLUE}‚ïë          üìä Installation Summary        ‚ïë${NC}"
    echo -e "${BLUE}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
    echo ""
    
    echo -e "${CYAN}Environment:${NC}"
    echo "  OS: Android $ANDROID_VERSION (SDK $ANDROID_SDK)"
    echo "  Architecture: $ARCHITECTURE"
    echo "  Python: $(python --version 2>&1 | awk '{print $2}')"
    echo ""
    
    echo -e "${CYAN}Installed Versions:${NC}"
    echo "  frida-tools: $(frida --version 2>/dev/null || echo 'Failed')"
    echo "  frida-server: $(su -c '/data/local/tmp/frida-server --version' 2>/dev/null || echo 'Failed')"
    echo ""
    
    echo -e "${CYAN}Status:${NC}"
    if pgrep -f frida-server > /dev/null; then
        echo -e "  frida-server: ${GREEN}Running${NC} (PID: $(pgrep -f frida-server))"
    else
        echo -e "  frida-server: ${RED}Not running${NC}"
    fi
    
    if frida-ps -H 127.0.0.1:27042 &>/dev/null; then
        echo -e "  Connection: ${GREEN}Working${NC} (localhost mode)"
    else
        echo -e "  Connection: ${RED}Failed${NC}"
    fi
    
    # SELinux status
    local selinux=$(su -c "getenforce" 2>/dev/null || echo "Unknown")
    echo -e "  SELinux: $selinux"
    if [ "$selinux" = "Enforcing" ]; then
        echo -e "    ${YELLOW}‚ö†Ô∏è  May cause issues${NC}"
    fi
    echo ""
    
    echo -e "${CYAN}Helper Scripts:${NC}"
    echo "  ~/frida-start   - Start frida-server"
    echo "  ~/frida-stop    - Stop frida-server"
    echo "  ~/frida-status  - Check detailed status"
    echo "  ~/frida-test    - Test connection modes"
    echo ""
    
    echo -e "${CYAN}Connection Mode:${NC}"
    echo "  Localhost: -H 127.0.0.1:27042 (Recommended) ‚≠ê"
    echo "  Auto USB:  -U"
    echo "  Remote:    -R"
    echo ""
    
    echo -e "${CYAN}Quick Commands:${NC}"
    echo "  ${YELLOW}# List processes${NC}"
    echo "  frida-ps -H 127.0.0.1:27042"
    echo ""
    echo "  ${YELLOW}# List apps${NC}"
    echo "  frida-ps -H 127.0.0.1:27042 -a"
    echo ""
    echo "  ${YELLOW}# List running apps${NC}"
    echo "  frida-ps -H 127.0.0.1:27042 -ai"
    echo ""
    echo "  ${YELLOW}# Search app${NC}"
    echo "  frida-ps -H 127.0.0.1:27042 -ai | grep whatsapp"
    echo ""
    echo "  ${YELLOW}# Use Objection${NC}"
    echo "  objection -N -h 127.0.0.1 -p 27042 -g <package> explore"
    echo ""
    echo "  ${YELLOW}# Use Frida script${NC}"
    echo "  frida -H 127.0.0.1:27042 -f <package> -l script.js"
    echo ""
    
    echo -e "${CYAN}Troubleshooting:${NC}"
    echo "  ${YELLOW}# If connection fails${NC}"
    echo "  ~/frida-start"
    echo "  su -c 'setenforce 0'"
    echo ""
    echo "  ${YELLOW}# Check status${NC}"
    echo "  ~/frida-status"
    echo ""
    
    echo -e "${CYAN}Log File:${NC}"
    echo "  $LOG_FILE"
    echo ""
    
    # Tips
    echo -e "${CYAN}üí° Tips:${NC}"
    echo "  ‚Ä¢ Use ${YELLOW}-H 127.0.0.1:27042${NC} for all Frida commands"
    echo "  ‚Ä¢ Run ${YELLOW}~/frida-status${NC} to check everything"
    echo "  ‚Ä¢ Run ${YELLOW}~/frida-test${NC} to test connection modes"
    echo "  ‚Ä¢ If SELinux is Enforcing, run: ${YELLOW}su -c 'setenforce 0'${NC}"
    echo ""
}

#============================================
# Main Program
#============================================

main() {
    # ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
    print_header
    echo "Starting installation at $(date)"
    echo "Log file: $LOG_FILE"
    echo ""
    log "=== Frida Auto-Installer Started ==="
    
    # ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á
    check_environment || exit 1
    install_dependencies || exit 1
    detect_compatible_frida_version || exit 1
    
    # ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á
    echo ""
    print_warning "Ready to install Frida $FRIDA_VERSION"
    read -p "Continue? (y/n): " confirm
    if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
        echo "Installation cancelled"
        exit 0
    fi
    
    install_frida_tools || exit 1
    install_frida_server || exit 1
    configure_selinux
    start_frida_server || exit 1
    test_frida
    create_helper_scripts
    
    # ‡∏™‡∏£‡∏∏‡∏õ
    show_summary
    
    echo -e "${GREEN}‚úÖ Installation Complete!${NC}"
    echo ""
    log "=== Installation Completed Successfully ==="
}

# Error handling
trap 'echo -e "\n${RED}Error occurred. Check log: $LOG_FILE${NC}"; exit 1' ERR

# ‡∏£‡∏±‡∏ô‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°
main "$@"
