#!/data/data/com.termux/files/usr/bin/bash
# =====================================================
# Frida Downgrade Script - à¸¥à¸”à¹€à¸§à¸­à¸£à¹Œà¸Šà¸±à¸™à¹€à¸›à¹‡à¸™ 16.5.6
# à¸§à¸´à¸˜à¸µà¹ƒà¸Šà¹‰: chmod 777 downgrade_frida.sh && ./downgrade_frida.sh
# =====================================================

clear
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘      Frida Downgrade to 16.5.6 for Termux                â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Target version
TARGET_FRIDA_VER="16.5.6"
TARGET_TOOLS_VER="12.3.0"

# ==================== Check Current Version ====================
echo -e "${BLUE}[Step 1/8]${NC} Checking current Frida version..."
echo ""

if command -v frida &> /dev/null; then
    CURRENT_VER=$(frida --version 2>/dev/null || echo "unknown")
    echo "Current version: $CURRENT_VER"
    
    if [ "$CURRENT_VER" == "$TARGET_FRIDA_VER" ]; then
        echo -e "${GREEN}[+] Already on version $TARGET_FRIDA_VER${NC}"
        read -p "Reinstall anyway? (y/n): " REINSTALL
        if [ "$REINSTALL" != "y" ]; then
            exit 0
        fi
    fi
else
    echo "Frida not installed"
fi
echo ""

# ==================== Device Info ====================
echo -e "${BLUE}[Step 2/8]${NC} Detecting device architecture..."
echo ""

CPU_ABI=$(getprop ro.product.cpu.abi)
echo "CPU ABI: $CPU_ABI"

case "$CPU_ABI" in
    "arm64-v8a")
        FRIDA_ARCH="arm64"
        ;;
    "armeabi-v7a")
        FRIDA_ARCH="arm"
        ;;
    "x86_64")
        FRIDA_ARCH="x86_64"
        ;;
    "x86")
        FRIDA_ARCH="x86"
        ;;
    *)
        echo -e "${RED}[!] Unknown architecture: $CPU_ABI${NC}"
        exit 1
        ;;
esac

echo -e "${GREEN}[+] Architecture: $FRIDA_ARCH${NC}"
echo ""

# ==================== Backup Check ====================
echo -e "${BLUE}[Step 3/8]${NC} Checking for existing frida-server..."
echo ""

if [ -f /data/local/tmp/frida-server ]; then
    echo "[*] Found existing frida-server, backing up..."
    su -c 'cp /data/local/tmp/frida-server /data/local/tmp/frida-server.backup' 2>/dev/null || \
    tsu -c 'cp /data/local/tmp/frida-server /data/local/tmp/frida-server.backup' 2>/dev/null
    echo -e "${GREEN}[+] Backup created${NC}"
else
    echo "[*] No existing server found"
fi
echo ""

# ==================== Uninstall Current Version ====================
echo -e "${BLUE}[Step 4/8]${NC} Uninstalling current Frida..."
echo ""

echo "[*] Stopping frida-server..."
su -c 'pkill -9 frida-server' 2>/dev/null || tsu -c 'pkill -9 frida-server' 2>/dev/null
sleep 1

echo "[*] Uninstalling frida and frida-tools..."
pip uninstall -y frida frida-tools 2>/dev/null
pip uninstall -y frida 2>/dev/null
pip uninstall -y frida-tools 2>/dev/null

echo -e "${GREEN}[+] Uninstalled!${NC}"
echo ""

# ==================== Install Dependencies ====================
echo -e "${BLUE}[Step 5/8]${NC} Checking dependencies..."
echo ""

pkg install -y python python-pip wget curl xz-utils

# à¸­à¸±à¸à¹€à¸”à¸— pip (à¸£à¸°à¸§à¸±à¸‡à¸­à¸¢à¹ˆà¸²à¹ƒà¸«à¹‰à¹€à¸ªà¸µà¸¢)
python -m pip install --upgrade pip setuptools wheel 2>/dev/null

echo -e "${GREEN}[+] Dependencies ready!${NC}"
echo ""

# ==================== Install Frida 16.5.6 ====================
echo -e "${BLUE}[Step 6/8]${NC} Installing Frida $TARGET_FRIDA_VER..."
echo ""

echo "[*] Installing frida $TARGET_FRIDA_VER..."
pip install frida==$TARGET_FRIDA_VER

echo "[*] Installing frida-tools $TARGET_TOOLS_VER..."
pip install frida-tools==$TARGET_TOOLS_VER

# Verify
if command -v frida &> /dev/null; then
    INSTALLED_VER=$(frida --version)
    if [ "$INSTALLED_VER" == "$TARGET_FRIDA_VER" ]; then
        echo -e "${GREEN}[+] Frida $INSTALLED_VER installed successfully!${NC}"
    else
        echo -e "${YELLOW}[!] Warning: Installed version is $INSTALLED_VER${NC}"
    fi
else
    echo -e "${RED}[!] Installation failed!${NC}"
    exit 1
fi
echo ""

# ==================== Download Frida Server ====================
echo -e "${BLUE}[Step 7/8]${NC} Downloading frida-server $TARGET_FRIDA_VER..."
echo ""

FRIDA_SERVER_NAME="frida-server-${TARGET_FRIDA_VER}-android-${FRIDA_ARCH}"
DOWNLOAD_URL="https://github.com/frida/frida/releases/download/${TARGET_FRIDA_VER}/${FRIDA_SERVER_NAME}.xz"

echo "[*] URL: $DOWNLOAD_URL"
echo ""

cd ~
rm -f frida-server.xz frida-server 2>/dev/null

# Download with progress
if curl -L -o frida-server.xz "$DOWNLOAD_URL" --progress-bar; then
    echo -e "${GREEN}[+] Downloaded!${NC}"
else
    echo -e "${RED}[!] Download failed!${NC}"
    exit 1
fi

# Extract
echo "[*] Extracting..."
xz -d -f frida-server.xz

if [ ! -f frida-server ]; then
    echo -e "${RED}[!] Extract failed!${NC}"
    exit 1
fi

chmod 755 frida-server
echo -e "${GREEN}[+] Extracted successfully!${NC}"
echo ""

# ==================== Install to Device ====================
echo -e "${BLUE}[Step 8/8]${NC} Installing frida-server to device..."
echo ""

# Test root
echo "[*] Testing root access..."
ROOT_CMD=""

if command -v tsu &> /dev/null; then
    if tsu -c 'id' 2>/dev/null | grep -q "uid=0"; then
        ROOT_CMD="tsu -c"
        echo -e "${GREEN}[+] Root: tsu${NC}"
    fi
fi

if [ -z "$ROOT_CMD" ]; then
    if su -c 'id' 2>/dev/null | grep -q "uid=0"; then
        ROOT_CMD="su -c"
        echo -e "${GREEN}[+] Root: su -c${NC}"
    fi
fi

if [ -z "$ROOT_CMD" ]; then
    echo -e "${YELLOW}[!] Root not available${NC}"
    echo ""
    echo "Manual installation required:"
    echo ""
    echo "  su"
    echo "  pkill -9 frida-server"
    echo "  cp ~/frida-server /data/local/tmp/"
    echo "  chmod 755 /data/local/tmp/frida-server"
    echo "  exit"
    echo ""
else
    # Install
    echo "[*] Stopping old server..."
    $ROOT_CMD 'pkill -9 frida-server' 2>/dev/null
    sleep 1
    
    echo "[*] Copying to /data/local/tmp..."
    $ROOT_CMD "cp $HOME/frida-server /data/local/tmp/frida-server"
    $ROOT_CMD 'chmod 755 /data/local/tmp/frida-server'
    
    # Verify
    echo "[*] Verifying installation..."
    SERVER_VER=$($ROOT_CMD '/data/local/tmp/frida-server --version' 2>/dev/null)
    
    if [ "$SERVER_VER" == "$TARGET_FRIDA_VER" ]; then
        echo -e "${GREEN}[+] frida-server $SERVER_VER installed!${NC}"
    else
        echo -e "${YELLOW}[!] Server version: $SERVER_VER${NC}"
    fi
fi

# ==================== Final Check ====================
echo ""
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘              âœ… Downgrade Complete!                       â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

CLIENT_VER=$(frida --version 2>/dev/null)
SERVER_VER=$($ROOT_CMD '/data/local/tmp/frida-server --version' 2>/dev/null)

echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
echo "â”‚ ğŸ“‹ Version Check                                â”‚"
echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
echo "â”‚ Target         : $TARGET_FRIDA_VER                          â”‚"
echo "â”‚ Frida Client   : $CLIENT_VER                          â”‚"
echo "â”‚ Frida Server   : $SERVER_VER                          â”‚"
echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
echo ""

if [ "$CLIENT_VER" == "$SERVER_VER" ] && [ "$CLIENT_VER" == "$TARGET_FRIDA_VER" ]; then
    echo -e "${GREEN}âœ… Version matched perfectly!${NC}"
else
    echo -e "${YELLOW}âš ï¸  Version mismatch detected${NC}"
    echo ""
    echo "If versions don't match, try:"
    echo "  pip uninstall frida frida-tools -y"
    echo "  pip install frida==$TARGET_FRIDA_VER frida-tools==$TARGET_TOOLS_VER"
fi

echo ""
echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
echo "â”‚ ğŸš€ Quick Start                                   â”‚"
echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
echo "â”‚                                                 â”‚"
echo "â”‚ 1. Start server:                                â”‚"
echo "â”‚    ~/start_frida.sh                             â”‚"
echo "â”‚                                                 â”‚"
echo "â”‚ 2. Test:                                        â”‚"
echo "â”‚    frida-ps -H 127.0.0.1:27042                  â”‚"
echo "â”‚                                                 â”‚"
echo "â”‚ 3. Check versions:                              â”‚"
echo "â”‚    frida --version                              â”‚"
echo "â”‚    su -c '/data/local/tmp/frida-server -v'      â”‚"
echo "â”‚                                                 â”‚"
echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
echo ""
