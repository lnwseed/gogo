#!/data/data/com.termux/files/usr/bin/bash
# =====================================================
# Frida 16.5.6 Setup with Node.js (Fixed version)
# =====================================================

clear
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘   Frida 16.5.6 Setup (Node.js - Fixed Install)          â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m'

# ==================== Update Termux ====================
echo -e "${BLUE}[1/5]${NC} Updating Termux..."
pkg update -y && pkg upgrade -y
echo ""

# ==================== Install Dependencies ====================
echo -e "${BLUE}[2/5]${NC} Installing dependencies..."
pkg install -y nodejs wget xz-utils tsu
echo ""

# ==================== Install Frida CLI ====================
echo -e "${BLUE}[3/5]${NC} Installing Frida 16.5.6..."
echo ""

# à¸¥à¸šà¹€à¸§à¸­à¸£à¹Œà¸Šà¸±à¸™à¹€à¸à¹ˆà¸² (à¸–à¹‰à¸²à¸¡à¸µ)
npm uninstall -g frida 2>/dev/null

# à¸•à¸´à¸”à¸•à¸±à¹‰à¸‡à¹à¸šà¸š silent mode + force
echo "[*] Installing frida@16.5.6 (this may take a while)..."
npm install -g frida@16.5.6 --quiet --force --no-optional --legacy-peer-deps

# à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š
if command -v frida &> /dev/null; then
    FRIDA_VER=$(frida --version 2>/dev/null)
    if [ -n "$FRIDA_VER" ]; then
        echo -e "${GREEN}âœ… Frida CLI installed: $FRIDA_VER${NC}"
    else
        echo -e "${YELLOW}âš ï¸  Frida installed but version check failed${NC}"
    fi
else
    echo -e "${YELLOW}âŒ Failed to install Frida CLI${NC}"
    echo ""
    echo "Try manual installation:"
    echo "  npm cache clean --force"
    echo "  npm install -g frida@16.5.6 --verbose"
    exit 1
fi
echo ""

# ==================== Detect Architecture ====================
echo -e "${BLUE}[4/5]${NC} Detecting device architecture..."
CPU_ABI=$(getprop ro.product.cpu.abi)

case "$CPU_ABI" in
    "arm64-v8a") ARCH="arm64" ;;
    "armeabi-v7a") ARCH="arm" ;;
    "x86_64") ARCH="x86_64" ;;
    "x86") ARCH="x86" ;;
    *) ARCH="arm64" ;;
esac

echo "Architecture: $ARCH"
echo ""

# ==================== Download frida-server ====================
echo -e "${BLUE}[5/5]${NC} Installing frida-server 16.5.6..."

FRIDA_VER="16.5.6"
cd ~

# à¸¥à¸šà¹„à¸Ÿà¸¥à¹Œà¹€à¸à¹ˆà¸²
rm -f frida-server* 2>/dev/null

# à¸”à¸²à¸§à¸™à¹Œà¹‚à¸«à¸¥à¸”
echo "[*] Downloading..."
wget -q --show-progress \
  "https://github.com/frida/frida/releases/download/${FRIDA_VER}/frida-server-${FRIDA_VER}-android-${ARCH}.xz"

if [ ! -f frida-server-*.xz ]; then
    echo "âŒ Download failed!"
    exit 1
fi

# à¹à¸•à¸à¹„à¸Ÿà¸¥à¹Œ
echo "[*] Extracting..."
xz -d frida-server-*.xz
mv frida-server-* frida-server
chmod 755 frida-server

# Copy à¹„à¸›à¸¡à¸·à¸­à¸–à¸·à¸­
echo "[*] Installing to /data/local/tmp..."

if command -v tsu &> /dev/null; then
    ROOT_CMD="tsu -c"
else
    ROOT_CMD="su -c"
fi

$ROOT_CMD "pkill -9 frida-server" 2>/dev/null
$ROOT_CMD "cp $HOME/frida-server /data/local/tmp/"
$ROOT_CMD "chmod 755 /data/local/tmp/frida-server"

SERVER_VER=$($ROOT_CMD "/data/local/tmp/frida-server --version" 2>/dev/null)

if [ -n "$SERVER_VER" ]; then
    echo -e "${GREEN}âœ… frida-server installed: $SERVER_VER${NC}"
else
    echo -e "${YELLOW}âš ï¸  Server installed but version check needs root${NC}"
fi
echo ""

# ==================== Create Helper Scripts ====================
echo "[*] Creating helper scripts..."

cat > ~/start_frida.sh << 'EOF'
#!/data/data/com.termux/files/usr/bin/bash
echo "ðŸš€ Starting frida-server..."

# Kill existing
tsu -c "pkill -9 frida-server" 2>/dev/null || su -c "pkill -9 frida-server" 2>/dev/null
sleep 1

# Start server
tsu -c "/data/local/tmp/frida-server -l 0.0.0.0:27042 -D" 2>/dev/null || \
su -c "/data/local/tmp/frida-server -l 0.0.0.0:27042 -D" 2>/dev/null &

sleep 2

# Test
if frida-ps -H 127.0.0.1:27042 &>/dev/null; then
    echo "âœ… Server running on port 27042"
else
    echo "âŒ Failed to start (check root access)"
fi
EOF
chmod 755 ~/start_frida.sh

cat > ~/hook.sh << 'EOF'
#!/data/data/com.termux/files/usr/bin/bash
[ -z "$1" ] && echo "Usage: ./hook.sh <package> [script.js]" && exit 1
frida -H 127.0.0.1:27042 -f "$1" ${2:+-l "$2"} --no-pause
EOF
chmod 755 ~/hook.sh

echo -e "${GREEN}âœ… Setup complete!${NC}"
echo ""
echo "Start server: ~/start_frida.sh"
echo "Hook app: ~/hook.sh com.example.app script.js"
echo ""
